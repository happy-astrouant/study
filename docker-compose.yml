version: "3"
services:
  nodeos:
    container_name: server
    image: eosio/eos:v1.1.0
    command: nodeosd.sh -e --http-alias=server:8888 --http-alias=127.0.0.1:8888 --http-alias=localhost:8888
    ports:
    - 8888:8888
    logging:
      driver: none

## Create master account
  cleos:
    image: eosio/eos-dev:v1.1.0
    command:
    - /bin/bash
    - -c
    - |
      cleos wallet create
      cleos wallet import --private-key $$EOS_PRIVATE 
      cleos wallet import --private-key 5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3 #default eosio account private key
      cleos -u $$EOS_API create account eosio master $$EOS_PUBLIC
      eosiocpp -g iryo.abi iryo.cpp
      eosiocpp -o iryo.wast iryo.cpp
    volumes: 
    - ./contract:/contract
    working_dir: /contract
    environment:
    - EOS_API=http://server:8888 # url on which nodeos is running
    - EOS_PRIVATE=5KRuLTUU5pzPBhVPv2JkgXGtRoCM8g36PRCAxaCANYwJ7DH15tn # key used to sign master account
    - EOS_PUBLIC=EOS8Bi2k2R4Zv3Go2FEBAM6X8nu7aDPBDWGZeNhewhQZQThe61nc7 # key used to create master account (public key of $EOS_PRIVATE)
    tty: true
    depends_on:
    - nodeos
## Cleos interface
  tools:
    image: eosio/eos-dev:v1.1.0
    command:
    - bash
    environment:
    - EOS_API=http://server:8888 # url on which nodeos is running
    tty: true
## Deploy contract
  deploy:
    image: iryo
    command:
    - go
    - run
    - main.go
    volumes:
    - ./:/go/src/github.com/iryonetwork/network-poc
    working_dir: /go/src/github.com/iryonetwork/network-poc/cmd/deploy_eos_contract
    environment:
    - EOS_API=http://server:8888
    - EOS_ACCOUNT=iryo
    - EOS_CONTRACT_NAME=iryo
    - EOS_TOKEN_ACCOUNT=iryo.token
    - EOS_TOKEN_NAME=eosio.token
    - EOS_PRIVATE=5KRuLTUU5pzPBhVPv2JkgXGtRoCM8g36PRCAxaCANYwJ7DH15tn # key used to sign master account
  api:
    image: iryo
    command:
    - go
    - run
    - main.go
    - handlers.go
    - wshandlers.go
    volumes:
    - ./:/go/src/github.com/iryonetwork/network-poc
    - ./.data:/data
    working_dir: /go/src/github.com/iryonetwork/network-poc/cmd/api
    environment:
    - IRYO_ADDR=0.0.0.0:8000
    - EOS_API=http://server:8888
    - EOS_CONTRACT_NAME=iryo
    - EOS_TOKEN_ACCOUNT=iryo.token
    - EOS_PRIVATE=5KRuLTUU5pzPBhVPv2JkgXGtRoCM8g36PRCAxaCANYwJ7DH15tn # key used to sign master account
    - DEBUG=1
    ports:
    - 8000:8000
    depends_on:
    - nodeos
  ## patient server
  patient1:
    image: iryo
    command:
    - go
    - run
    - main.go
    - handlers.go
    volumes:
    - ./:/go/src/github.com/iryonetwork/network-poc
    working_dir: /go/src/github.com/iryonetwork/network-poc/cmd/patient
    environment:
    - IRYO_ADDR=api:8000
    - EOS_API=http://server:8888
    - EOS_CONTRACT_NAME=iryo
    - CLIENT_ADDR=0.0.0.0:9000
    - DEBUG=1
    ports:
    - 9001:9000
    depends_on:
    - api
  patient2:
    image: iryo
    command:
    - go
    - run
    - main.go
    - handlers.go
    volumes:
    - ./:/go/src/github.com/iryonetwork/network-poc
    working_dir: /go/src/github.com/iryonetwork/network-poc/cmd/patient
    environment:
    - IRYO_ADDR=api:8000
    - EOS_API=http://server:8888
    - EOS_CONTRACT_NAME=iryo
    - CLIENT_ADDR=0.0.0.0:9000
    - DEBUG=1
    ports:
    - 9002:9000
    depends_on:
    - api
  ## Doctor
  doctor1:
    image: iryo
    command:
    - go
    - run
    - main.go
    - handlers.go
    volumes:
    - ./:/go/src/github.com/iryonetwork/network-poc
    working_dir: /go/src/github.com/iryonetwork/network-poc/cmd/doctor
    environment:
    - EOS_API=http://server:8888
    - IRYO_ADDR=api:8000
    - EOS_CONTRACT_NAME=iryo
    - CLIENT_ADDR=0.0.0.0:9000
    - DEBUG=1
    ports:
    - 9003:9000
    depends_on:
    - api
  ## Doctor
  doctor2:
    image: iryo
    command:
    - go
    - run
    - main.go
    - handlers.go
    volumes:
    - ./:/go/src/github.com/iryonetwork/network-poc
    working_dir: /go/src/github.com/iryonetwork/network-poc/cmd/doctor
    environment:
    - EOS_API=http://server:8888
    - IRYO_ADDR=api:8000
    - EOS_CONTRACT_NAME=iryo
    - CLIENT_ADDR=0.0.0.0:9000
    - DEBUG=1
    ports:
    - 9004:9000
    depends_on:
    - api

volumes:
  devchain:
